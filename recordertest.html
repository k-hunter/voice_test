<!DOCTYPE html>
	<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width">
		<title>Web Recorder Beta1.0</title>
	</head>
	<body>
        <div class="maincontrol">
                <button id="Start">Start</button>
                <button id="Stop">Stop</button>
                <button id="Save">Save</button>
        </div>
        <section class="sound-clips"></section>
    </body>
    
    <script>
    var record = document.getElementById('Start');
    var stop = document.getElementById('Stop');
    var soundClips = document.querySelector('.sound-clips');

    stop.disabled = true;

    var audioCtx = new (window.AudioContext || webkitAudioContext)();
    if (navigator.mediaDevices.getUserMedia) {
        console.log('支持getUserMedia属性');
        var constraints = {audio: true};
        var chunks = [];

        var onSuccess = function(stream) {
            var mediaRecorder = new MediaRecorder(stream);
            record.onclick = function(){
                mediaRecorder.start();
                console.log(mediaRecorder.state);
                console.log("开始录音");
                record.style.background = "red";
                
                stop.disabled = false;
                record.disabled = true;
            }
            stop.onclick = function(){
                mediaRecorder.stop();
                console.log(mediaRecorder.state);
                console.log("停止录音");
                record.style.background = "";
                record.style.color = "";

                stop.disabled = true;
                record.disabled = false;
            }
            mediaRecorder.onstop = function(e) {
                console.log("可保存数据");
                var clipName = prompt('给你的新录音命个名：','新录音');
                console.log(clipName);
                var clipContainer = document.createElement('article');
                var clipLabel = document.createElement('p');
                var audio = document.createElement('audio');
                var deleteButton = document.createElement('button');

                clipContainer.classList.add('clip');
                audio.setAttribute('controls','');
                deleteButton.textContent = 'Delete';
                deleteButton.className = 'delete';

                if(clipName === null) {
                    clipLabel.textContent = '未命名录音';
                } else {
                    clipLabel.textContent = clipName;
                }

                clipContainer.appendChild(audio);
                clipContainer.appendChild(clipLabel);
                clipContainer.appendChild(deleteButton);
                soundClips.appendChild(clipContainer);

                audio.controls = true;
                var blob = new Blob(chunks,{ 'type' : 'audio/ogg; codecs=opus' });
                chunks = [];
                var audioURL = window.URL.createObjectURL(blob);
                audio.src = audioURL;
                console.log("录音完成");

                deleteButton.onclick = function(e) {
                    evtTgt = e.target;
                    evtTgt.parentNode.parentNode.removeChild(evtTgt.parentNode);
                }
                clipLabel.onclick = function(){
                    var existingName = clipLabel.textContent;
                    var newClipName = prompt("给你的录音起个新名字：");
                    if (newClipName === null){
                        clipLabel.textContent = existingName;
                    } else {
                        clipLabel.textContent = newClipName;
                    }
                }
            }
            mediaRecorder.ondataavailable = function(e) {
                chunks.push(e.data);
            }
        }
        var onError = function(err) {
            console.log("错误出现在：　"　+ err);
        }
        navigator.mediaDevices.getUserMedia(constraints).then(onSuccess,onError);
    } else {
        console.log('浏览器不支持getUserMedia!');
    }
    </script>
	</html>	